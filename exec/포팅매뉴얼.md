# 포팅 매뉴얼
> SSAFY 5기 공통프로젝트 서울 1반 1팀 오나코(OHNACO)


## 1. 프로젝트 개발 환경 
- Java 8
- Spring Boot `2.5.3`
- Vue 2
- Nginx `1.18.0`
- IntelliJ IDEA `2020.2`
- mariaDB `10.3.31-MariaDB`
- Redis `5.0.7`
- Docker `20.10.8`


## 2. 프로젝트 세팅 방법 

- 먼저 git repository를 clone해서 받아온다. 

```
git clone https://lab.ssafy.com/s05-webmobile2-sub3/S05P13A101.git
```

### Database Setting
```
sudo apt update && sudo apt-get -y upgrade
sudo apt-get install -y mariadb-server
mysql -u root -p
```
- mariadb: root / root 

### Redis Setting 
```dockerfile=
docker run --name redis -p 6379:6379 -d redis redis-server \
--appendonly yes --requirepass "Redis 패스워드" 
```

> Spring Boot의 application.properties : spring.redis.password에 'Redis 패스워드' 설정이 필요합니다. 

- redis: redis-cli에서 auth ssafyroot로 접속 

#### 주요 계정 정보 
application.properties 참고 

### nginx Setting 
1. nginx 설치 
```
# nginx 설치 
sudo apt-get install nginx 

# 잘 설치되었나 확인 
sudo service nginx status  
```
2. vi 에디터 실행
```
sudo vi /etc/nginx/sites-enabled/default
```
3. 에디터에서 아래 내용 그대로 작성
```
upstream backend {
  server localhost:8197;
  server localhost:8196;
}
server {
    root /'프로젝트 디렉토리'/S05P13A101/frontend/dist;

    index index.html;

    server_name i5a101.p.ssafy.io;

    location / {
            try_files $uri $uri/ /index.html;
    }

    ### backend reverse proxy ###
    location /api {
            proxy_pass https://backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-forwarded-Port $server_port;
    }
    
    ...
}
``````

3. 설정 변경 후 syntax 검사 
```
sudo nginx -t
```

4. 설정 변경 후 nginx 재시작 필수 
```
sudo service nginx restart
```


### SSL Setting 
```
# 저장소 추가
sudo add-apt-repository ppa:certbot/certbot

# apt-get 업데이트
sudo apt-get update 

# certbot 설치
sudo apt-get install python-certbot-nginx

# 인증서 설치 
sudo certbot --nginx -d '지정할 도메인'

# 이메일 등록 / 약관 동의 / http redirect 설정 (2번 선택)
```

### frontend 

- frontend 폴더로 이동하여 아래의 명령어로 node package를 설치한다. 
```
npm install 
```

- 아래의 명령어로 빌드한다. 
```
npm run build
```


### backend 

- 아래의 명령어로 빌드하여 jar파일을 생성한다. 
```
mvn package
```

- 아래의 명령어를 통해 2개의 포트로 서버를 실행시킨다. 
```
nohup java -jar target/*.jar —server.port=8197 &
nohup java -jar target/*.jar —server.port=8196 &
```

- 최신 버전 반영 시
```
# 실행중인 서버 끄기 
sudo kill -9 `pgrep java`

# git pull 하고 

mvn package
nohup java -jar target/*.jar —server.port=8197 &
nohup java -jar target/*.jar —server.port=8196 &
```
    



## 3. 사용 외부 서비스 정보 
- aws s3 (Vue 버전)
```
1. aws 계정 생성

2. s3 버킷 만들기 리전(아시아 태평양 서울)

3. 만든객체에서 권한 cors 설정
[
    {
        "AllowedHeaders": [
            "*"
        ],
        "AllowedMethods": [
            "HEAD",
            "GET",
            "PUT",
            "POST",
            "DELETE"
        ],
        "AllowedOrigins": [
            "*"
        ],
        "ExposeHeaders": [
            "ETag",
            "x-amz-meta-custom-header"
        ]
    }
]

4. 모든 퍼블릭 액세스 차단 해제 후 버킷정책 설정
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": [
                "s3:GetObject",
                "s3:GetObjectVersion"
            ],
            "Resource": "arn:aws:s3:::BUCKET_NAME/*"
        }
    ]
}

5. https://console.aws.amazon.com/cognito/ 
이동 후 자격증명 풀 생성 (리전은 위와 동일하게)

6. 이름 작성 후 인증되지 않은 자격 증명 활성화

7. 생성후 자격증명 풀 편집에서 인증되지 않은 역활에서 새 역할 생성

8. 정책문서에 아래와 같이 작성
{
   "Version": "2012-10-17",
   "Statement": [
      {
         "Effect": "Allow",
         "Action": [
            "s3:*"
         ],
         "Resource": [
            "arn:aws:s3:::BUCKET_NAME/*",
            "arn:aws:s3:::BUCKET_NAME"
         ]
      }
   ]
}

9. 샘플 코드에서 플랫폼 자바스크립트로 변환 (키값으로 사용)
AWS.config.region= ~~~
IdentityPoolId: ~~~~

10. vue에서 aws-sdk설치후 사용
```

- FCM
```
1. Firebase 프로젝트 생성 

2. 웹 앱의 구성 스니펫 Vue에 추가 

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-analytics.js"></script>

<script>
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  var firebaseConfig = {
    apiKey: "AIzaSyAjoO1hK9KSuV3oEsXBjxf0BdSoFwJO6HY",
    authDomain: "ohnaco-notification.firebaseapp.com",
    projectId: "ohnaco-notification",
    storageBucket: "ohnaco-notification.appspot.com",
    messagingSenderId: "1097451483774",
    appId: "1:1097451483774:web:03068b7284ab4b03ea5e2f",
    measurementId: "G-8HLXHVJ0H7"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
</script>


3. 비공개 키 생성 후 backend 프로젝트에 저장 
- resources/firebase/fcm_service_key.json

4. 백엔드 코드 구현 
- FCM 초기화 
- 사용자 토큰 관리 
- 메세지 보내기 


5. 프론트엔드 구현 
• main.js
> foreground 상태에서 받은 알림 처리
> messaging.onMessage();

• firebase-messaging-sw.js
> background 상태에서 받은 알림 처리
> messaging.setBackgroundMessageHandler();

- Firebase 지원되는 환경인지 확인(ios, safari 지원 안 되는 오류 처리)
- 알림 허용 요청
- 전달받은 payload에 있는 정보로 Notification 생성 후 보내기

```

## 4. 데이터베이스 덤프 파일 
- `ohnaco.sql`




## 5. 시연 시나리오 


### 테스트 계정 

1. 주 계정 
- 사용자 ID : sonch12@naver.com
- 사용자 PW : 1234

2. 부 계정 
- 사용자 ID : sonch12@naver.com
- 사용자 PW : 1234
